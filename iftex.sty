%% iftex TeX engine tests
%% LaTeX3 Project
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either
%% version 1.3c of this license or (at your option) any later
%% version.
%%
%% Using ideas from:
%%
%% ifxetex Will Robertson
%% iftex  Persian TeX Group / Vafa Khalighi
%% ifluatex ifvtex Heiko Oberdiek
%% ifptex Takayuki YATO


\csname IFTEX\string @loaded\endcsname
\expandafter\let\csname IFTEX\string @loaded\endcsname\endinput


\begingroup\expandafter\expandafter\expandafter\endgroup
\expandafter\ifx\csname ProvidesPackage\endcsname\relax\else
  \ProvidesPackage{iftex}
    [2019/10/24 v1.0a TeX engine tests]
\fi

\expandafter\chardef\csname IFTEX@at@catcode\endcsname\catcode64
\catcode 64 11

% message format used in several if*tex existing packages
% Modified here to do a hard stop and not show any error context lines
\def\IFTEX@Require#1#2#3{%
  #1\else
      \newlinechar=10\relax
      \errorcontextlines=-1\relax
      \immediate\write20{^^J
      ********************************************^^J
      * #2 is required to compile this document.^^J
      * Sorry!^^J
      ********************************************}%
    \batchmode\read -1 to \@tempa
    #3%
}

\ifx\protected\@undefined
  \let\IFTEX@protected\relax
\else
  \let\IFTEX@protected\protected
\fi


\IFTEX@protected\def\RequireeTeX{\IFTEX@Require\ifetex{eTeX}\fi}
\IFTEX@protected\def\RequirePDFTeX{\IFTEX@Require\ifpdftex{pdfTeX}\fi}
\IFTEX@protected\def\RequireXeTeX{\IFTEX@Require\ifxetex{XeTeX}\fi}
\IFTEX@protected\def\RequireLuaTeX{\IFTEX@Require\ifluatex{LuaTeX}\fi}
\IFTEX@protected\def\RequireLuaHBTeX{\IFTEX@Require\ifluahbtex{LuaHBTeX}\fi}
\IFTEX@protected\def\RequirepTeX{\IFTEX@Require\ifptex{pTeX}\fi}
\IFTEX@protected\def\RequireupTeX{\IFTEX@Require\ifuptex{upTeX}\fi}
\IFTEX@protected\def\RequirepTeXng{\IFTEX@Require\ifptexng{pTeX-ng}\fi}
\IFTEX@protected\def\RequireVTeX{\IFTEX@Require\ifvtex{VTeX}\fi}
\IFTEX@protected\def\RequireAlephTeX{\IFTEX@Require\ifalephtex{Aleph}\fi}% alephtex as aleph name too generic


% As a matter of policy over-write any existing \if*tex macro and set
% by the tests here.

\def\IFTEX@let#1#2{%
  \expandafter\let\csname if#1\expandafter\endcsname
  \csname if#2\endcsname}

% etex (should always be true in latex based formats)
\ifx\numexpr\@undefined
  \IFTEX@let{etex}{false}
\else
  \IFTEX@let{etex}{true}
\fi
\IFTEX@let{eTeX}{etex}

% pdftex (including in dvi mode)
\ifx\pdftexversion\@undefined
  \IFTEX@let{pdftex}{false}
\else
  \IFTEX@let{pdftex}{true}
\fi
\IFTEX@let{PDFTeX}{pdftex}

% xetex
\ifx\XeTeXrevision\@undefined
  \IFTEX@let{xetex}{false}
\else
  \IFTEX@let{xetex}{true}
\fi
\IFTEX@let{XeTeX}{xetex}


% luatex (including luahbtex)
\ifx\directlua\@undefined
  \IFTEX@let{luatex}{false}
\else
  \IFTEX@let{luatex}{true}
\fi
\IFTEX@let{LuaTeX}{luatex}

% luahbtex
% use luaharfbuzz test rather than status.luatex_engine=="luahbtex" for issue #2
\IFTEX@let{luahbtex}{false}
\ifx\directlua\@undefined
\else
  \directlua{\detokenize{
   if(pcall(require, 'luaharfbuzz')) then
     tex.print("\\let\\ifluahbtex\\iftrue ")
   end
  }}
\fi
\IFTEX@let{LuaHBTeX}{luahbtex}


% ptex (including all variants)
\ifx\kanjiskip\@undefined
  \IFTEX@let{ptex}{false}
\else
  \IFTEX@let{ptex}{true}
\fi

% uptex (including euptex)
\ifx\enablecjktoken \@undefined
  \IFTEX@let{uptex}{false}
\else
  \IFTEX@let{uptex}{true}
\fi

% ptex-ng
\ifx\ngbanner\@undefined
  \IFTEX@let{ptexng}{false}
\else
  \IFTEX@let{ptexng}{true}
\fi

% vtex
\ifx\VTeXversion\@undefined
  \IFTEX@let{vtex}{false}
\else
  \IFTEX@let{vtex}{true}
\fi
\IFTEX@let{VTeX}{vtex}

% aleph
\IFTEX@let{alephtex}{false}
\ifptex\else
\ifx\omathchardef\@undefined
\else
  \IFTEX@let{alephtex}{true}
\fi
\fi
\IFTEX@let{AlephTeX}{alephtex}

\catcode64 \IFTEX@at@catcode